---
title: 'ุงูููู ุงูุซุงูู: ุชุญููู ุงูุจูุงูุงุช ุงูุฌูููุฉ ูุฑุจุทูุง ุจุงูุจูุงูุงุช ุงูุฅูููููููุฉ '
output:
  html_document:
    lang: ar
    css: ../sc/style.css
    df_print: paged
  pdf_document: default
editor_options:
  markdown:
    wrap: sentence
---

--

# ูุงูู ูููุงุช MAFุ

<br><br>

ููู **MAF** ูู ุงุฎุชุตุงุฑ ูู **Mutation Annotation Format**ุ ููู ุตูุบุฉ ูููุงุช ููุงุณูุฉ ุชูุณุชุฎุฏู ุจุดูู ูุงุณุน ูู ุงููุนูููุงุชูุฉ ุงูุญูููุฉ (Bioinformatics) ูุชุฎุฒูู ูุชูุซูู ุจูุงูุงุช ุงูุทูุฑุงุช ุงูุฌูููุฉ ุงูููุชุดูุฉ ูู ุงูุฏุฑุงุณุงุช ุงูุฌูููููุฉุ ุฎุตูุตูุง ูู ูุฌุงู ุฃุจุญุงุซ ุงูุณุฑุทุงู.

ููุนุชุจุฑ ููู ุงูู MAF ุชูุณูููุง ุฌุฏููููุง (ุฌุฏูู ูุตู ููุตูู ุจููุงุตู ุฃู ุชุจููุจุงุช) ูุถู ูุนูููุงุช ูุตููุฉ ุนู ูู ุทูุฑุฉ ุฌูููุฉุ ุจุญูุซ ูุชูุญ ููุจุงุญุซูู ุชุจุงุฏู ุงูุจูุงูุงุช ูุชุญููููุง ุจุทุฑููุฉ ููุญูุฏุฉ ูููุธูุฉ.

**๐ ุงููุญุชููุงุช ุงูุฃุณุงุณูุฉ ูููู MAF:**

โช๏ธ **Gene Symbol (ุฑูุฒ ุงูุฌูู)**: ุงุณู ุงูุฌูู ุงูุฐู ุญุฏุซุช ููู ุงูุทูุฑุฉ.

โช๏ธ **Chromosome (ุงููุฑูููุณูู)**: ูููุน ุงูุทูุฑุฉ ุนูู ุงููุฑูููุณูู.

โช๏ธ **Start/End Position (ููุถุน ุงูุจุฏุงูุฉ ูุงูููุงูุฉ):** ุงููููุน ุงูุฌููููู ููุทูุฑุงุช.

โช๏ธ **Variant Classification (ุชุตููู ุงูุทูุฑุฉ):** ูุญุฏุฏ ููุน ุงูุทูุฑุฉ (ูุซู: Silentุ Missenseุ Nonsenseุ Frame-shift...).

โช๏ธ **Variant Type (ููุน ุงูุชุบูุฑ):** ูุซู SNP (ุชุนุฏุฏ ุฃุดูุงู ุงูููููููุชูุฏุงุช ุงูููุฑุฏุฉ) ุฃู Insertion ุฃู Deletion.

โช๏ธ **Reference & Tumor Allele (ุงูุฃููู ุงููุฑุฌุนู ูุฃููู ุงููุฑู):** ููุงุฑูุฉ ุจูู ุงูุชุณูุณู ุงููุฑุฌุนู ูุงูุชุบูุฑ ุงููุฑุตูุฏ.

โช๏ธ **Sample Information (ูุนูููุงุช ุงูุนููุฉ):** ูุซู ุงููุฑูุถุ ููุน ุงููุณูุฌ (ูุฑูู ุฃู ุทุจูุนู).

ููุทูู ุงูุขู ููุนูู ุนูู ูุฐุง ุงูููู!

<br><br>

------------------------------------------------------------------------

## 1. ุณูููู ุจุชููุฆุฉ ุจูุฆุฉ ุงูุนููุ ุซู ูุญููู ุงูุญุฒู ุงูุจุฑูุฌูุฉ ุงูุชู ุณูุญุชุงุฌ ุฅูููุง ุฃุซูุงุก ูุฐู ุงููุฑุดุฉ.

<br><br>

```{r Setting up the environment}

library(maftools)
library(dplyr)
library(skimr)
library(tidyverse)
library(ggplot2)
library(data.table)
library(ggrepel)


```

<br><br>

## 2. ูููู ุจูุฑุงุกุฉ ููู ุงูุจูุงูุงุช ุงููุตููุฉ ุงูุฐู ุชู ุญูุธู ูู ุงูููู ุงูุฃูู

<br><br>

```{r load metadata}

url <- "https://raw.githubusercontent.com/Dalah-Info/health-info-bioinformatics-r/refs/heads/main/Day1/Breast_tumor_metadata_cleaned.csv"
Breast_tumor_metadata = read.csv(url,  row.names = NULL)

```

<br><br>

## 3. ูููู ุจูุฑุงุกุฉ ููู ุงูุทูุฑุงุช ุงูุฌูููุฉ: MFA

<br><br>

```{r load maf file}

url2 <- "https://github.com/Dalah-Info/health-info-bioinformatics-r/raw/refs/heads/main/maf_file/filtered_maf_breast_only_maftools.maf.gz"
maf_file = read.maf(maf = url2)

```

<br><br>

## 4. ูุณุชูุดู ุดูู ููู MAF ูุงูุจูุงูุงุช ุงููุณุฌูุฉ ููู

<br><br>

```{r explore maf file}

head(maf_file@data) #ุงูุจูุงูุงุช ุงููุตููุฉ ููุญููุงุช ูุฌุฏูุง ูู ูุฐู ุงูุฎุงูุฉ


```

ูููู ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ **skimr** ูุชูุฑุฃ ููุง ุงูููู ูุงููุง

```{r skim maf file}

skim(maf_file@data) 

```

<br><br>

## 5. ุฏูุฌ ููู ุงูุจูุงูุงุช ุงููุตููุฉ ูุงูุงูููููููุฉ ูุน ููู MAF

<br><br>

**ููุงุฐุงุ ๐ด**

ุนุงุฏุฉ ูุง ูุฃุชู ููู MAF ูููุตูุง ุนู ุงูููู ุงููุตููุ ููุญุชุงุฌ ูุฏูุฌููุง ูุนูุง ุญุชู ูุชููู ูู ุชุญููู ุงูุทูุฑุงุช ูุฑุจุทูุง ุจูุฐู ุงูุจูุงูุงุช.

**ูููุ ๐ด**

ูุญุชุงุฌ ุฅูู ุนููุฏ ูุงุญุฏ ูุดุชุฑู ุจูู ุงููููููุ ุนุงุฏุฉ ูููู ุฑูุฒ ุงูุนููุฉ

**ุฃูู ูุฌุฏ ุฑูุฒ ุงูุนููุฉุ ๐ด**

ูู ููู MAFุ ููุงู ููุทุงู ูู ุชุฑููุฒ ุงูุนููุงุช (Sample Barcoding) ูุฌุจ ุงูุงูุชุจุงู ูููุง:

1)  ููุท TCGA

2)  ููุท UUID

ุงุฎุชุฑ ุงูููุท ุงูููุฌูุฏ ูู ููู ุงูู MAF ูุฃูุถูุง ูู ุงูุจูุงูุงุช ุงููุตููุฉ (Metadata)ุ ุญุชู ุชุชููู ูู ุฑุจุท ุงูุฌุฏูููู ุจุงุณุชุฎุฏุงู ูุฐุง ุงูุนููุฏ.

```{r patient ID in MAF file}

head(unique(maf_file@data$Tumor_Sample_UUID), 5) #ูุงููุฌุฏ ูุฏุฎูุงุช

head(unique(maf_file@data$Tumor_Sample_Barcode),5)

```

<br><br>

ุณูู ูุฎุชุงุฑ ุฑูุฒ TCGA ูุฃู UUID ุบูุฑ ููุฌูุฏ ูู ููู ุงูู MAF.

**๐ด ุฑูุฒ ุงูุนููุฉ ูู ููู MAF:**

*TCGA-OL-A66K-01A-11D-A29N-09* ูู ุฑูุฒ ูุงูู ููุนููุฉ (sample/aliquot barcode).
ููุชูููู ูู:

โช๏ธ TCGA โ ุงููุดุฑูุน (Project)

โช๏ธ OL โ ูููุน ูุตุฏุฑ ุงููุณูุฌ (Tissue Source Site - TSS)

โช๏ธ A66K โ ูุนุฑูู ุงููุดุงุฑู (ุงููุฑูุถ) (Participant/Patient ID)

โช๏ธ 01A โ ููุน ุงูุนููุฉ + ุงููุงุฑูุฑุฉ (01 = ูุฑู ุฃููู "Primary tumor" ุ A = ูุงุฑูุฑุฉ)

โช๏ธ 11D โ ุงูุฌุฒุก + ุงููุญูู ุงูุญููู (11 = ุฌุฒุกุ D = DNA)

โช๏ธ A29N โ ุงูุตููุญุฉ (Plate)

โช๏ธ 09 โ ุงููุฑูุฒ (Center)

ูู ุชูุฌุฏ ูุฐู ุงูุจูุงูุงุช ูู ููู ุงูุจูุงูุงุช ุงููุตููุฉุ ููุชุญูู ูู ุฐูู

<br><br>

```{r explore patient ID in metadata}

head(unique(Breast_tumor_metadata$bcr_patient_barcode),5)

```

<br><br>

**๐ดุฑูุฒ ุงูุนููุฉ ูู ุงูุจูุงูุงุช ุงููุตููุฉ (Metadata):**

ูุฏููุง ููุท ุฑูุฒ ุงููุฑูุถ (Patient Barcode) ูุซู: *TCGA-EW-A6S9*ุ ููู ูุชููู ููุท ูู ุฃูู 12 ุญุฑููุง ูู ุฑูุฒ ุงูู TCGA ุงููุงูู ุงูููุฌูุฏ ูู ููู MAF.

โ ุฅุฐู ุงููุงุนุฏุฉ ูู: **ุฑูุฒ ุงููุฑูุถ ูู ุงูููู ุงููุตูู = ุฃูู 12 ุญุฑู ูู ุฑูุฒ ุงูุนููุฉ ูู ููู MAF**.

<br><br>

```{r get unique patient ID}

#ููุดุฆ ููู ุจูุงูุงุช ูุญุชูู ุนูู ุงูุฑูุฒ ุงูุทููู ูุงููุตูุฑ ูููุฑูุถุ ููุณุชุฎุฏูู ูุงุญูุง ููุฏูุฌ.

id_map <- data.frame(
  short_id = substr(maf_file@data$Tumor_Sample_Barcode, 1, 12),             # ูุนุฑูู ุงููุฑูุถ (12 ุญุฑู)
  Tumor_Sample_Barcode = as.character(maf_file@data$Tumor_Sample_Barcode),  # ุงููุนุฑูู ุงููุงูู ููุนููุฉ
  stringsAsFactors = FALSE
)

#ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ ุนูู ูุณุชูู ุงููุฑูุถ 
id_map <- id_map[!duplicated(id_map$short_id), ]


matched_clinical_data <- merge(
  x = Breast_tumor_metadata,     # ุงูุจูุงูุงุช ุงูุณุฑูุฑูุฉ
  y = id_map,                    # ุฎุฑูุทุฉ ุงููุนุฑููุงุช ูู ููู ุงูู MAF
  by.x = "bcr_patient_barcode",  # ุงุณู ุนููุฏ ุงููุฑูุถ ูู ุงูุจูุงูุงุช ุงูุณุฑูุฑูุฉ
  by.y = "short_id",             # ุงุณู ุนููุฏ ุงููุฑูุถ (12 ุญุฑู) ูู ุงูุฎุฑูุทุฉ
  all.x = FALSE                  # ุงุญุชูุธ ููุท ุจุงููุฑุถู ุงูููุฌูุฏูู ูู ุงูู MAF
)


## ุงูุขู: matched_clinical_data ูุญูู ููุท ุงููุฑุถู ุงููุทุงุจูููุ ูุจุฏุงุฎูู ุนููุฏ Tumor_Sample_Barcode ุงููุดุชุฑู.


```

<br><br>

**โ ูุณุชุทูุน ุงูุขู ุฅูุดุงุก ููู MAF ููุชููุ ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุตููุฉ ุงูุฅูููููููุฉ:**

<br><br>

```{r integrate maf and metadata file}

maf_file <- read.maf(maf = url2, clinicalData = matched_clinical_data, verbose = F)

```


---

## 5. ููุทูู ุงูุขู ูุงุณุชูุดุงู ุงูุทูุฑุงุช ุงูุฌูููุฉ ุงูููุณุฌูุฉ ูู ููู MAF!

<br><br>

### 5.1 ููุฎุต ุงูุทูุฑุงุช ุงูููุณุฌูุฉ ูู ููู MAF ููู ูุฑูุถ.

```{r get sample summary}

getSampleSummary(maf_file)

```

<br><br>

### 5.2 ููุฎุต ุงูุทูุฑุงุช ุงูููุณุฌูุฉ ูู ููู MAF ููู ุฌูู.


```{r get gene summary}

getGeneSummary(maf_file)

```

<br><br>

### 5.3 ุฑุณู ููุฎุต ุดุงูู ููุนุธู ุงูุจูุงูุงุช 

```{r plot maf summary}
# ุฑุณู ููุฎุต ุดุงูู: ุนุฏุฏ ุงูุทูุฑุงุชุ ูุณุจ ุงูุฃููุงุน ุงููุฎุชููุฉุ ุฅุญุตุงุฆูุงุช ุนุงูุฉ

plotmafSummary(maf = maf_file, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)

```

<br><br>

### 5.4 ุฑุณู Oncoplot ูุฃูุซุฑ 10 ุฌููุงุช ุชุนุฑุถุงู ููุทูุฑุงุช

ุชุนุจุฑ ุฑุณูุฉ ุงูู oncoplot ูุงุญุฏุฉ ูู ุฃุดูุฑ ุงูุฑุณููุงุช ุงููุฑุชุจุทุฉ ุจุฏุฑุงุณุฉ ุงูุทูุฑุงุช


```{r plot oncoplot of top 10 genes}

# oncoplot ูุนุฑุถ ุงูุฌููุงุช ุงูุฃุนูู ุชูุฑุงุฑุงู ูู ุนููุงุช ุงููุฑุถู

oncoplot(maf = maf_file, top = 10)

```

### 5.5 ๐ ุชุญููู Transition / Transversion (Ti/Tv)

```{r plot titv summary }

# ุญุณุงุจ ุฃููุงุน ุงูุงุณุชุจุฏุงู (Ti/Tv) ูู ุงูุทูุฑุงุช

laml.titv = titv(maf = maf_file, plot = FALSE, useSyn = TRUE)

# ุฑุณู ููุฎุต Ti/Tv
plotTiTv(res = laml.titv)

```

### 5.6 ุฑุณู ุชูุฒูุน ุงูุฃูููุงุช: Variant Allele Frequency

```{r Variant Allele Frequencies}

plotVaf(maf = maf_file, vafCol = NULL, top = 20)


```


### 5.7 โ๏ธ ุชุญููู ุงูุนูุงูุฉ ุจูู ุงูุฌููุงุชุ ูุชูุงูุถุฉ ุฃู ูุชุญุฏุฉุ

```{r somatic Interactions}
# ููุดู ุนู ุนูุงูุฉ ุงูุชุนุงูุด ุฃู ุงูุชูุงูู ุจูู ุงูุทูุฑุงุช ูู ุงูุฌููุงุช

somaticInteractions(maf = maf_file, top = 25, pvalue = c(0.05, 0.1))

```

## 6. ุชุญููู ุชุฃุซูุฑ ุงูุทูุฑุงุช ุนูู ุงูุญูุงุฉ (ูู ุชุคุซุฑ ุงูุทูุฑุงุช ูู ูุฐุง ุงูุฌูู ุนูู ูุฏุฉ ุงูุนูุดุ)

### 6.1 ูุชุฃูุฏ ุจุฃู ุงูุจูุงูุงุช ุชุณุชููู ุงูุดูู ุงููุทููุจ ูุชุทุจูู ุงูุชุญููู

```{r data engineering - survival analysis}

# 1) ุชุญููู ุญุงูุฉ ุงูููุงุฉ ุฅูู 0/1
maf_file@clinical.data$vital_status <- ifelse(maf_file@clinical.data$vital_status %in% c("Dead", "1"), 1, 0)

# 2) ุชุญููู ุงูุฃูุงู ุฅูู ููู ุฑูููุฉ
num <- function(x) suppressWarnings(as.numeric(as.character(x)))
dtd  <- num(maf_file@clinical.data$days_to_death)
dtlf <- num(maf_file@clinical.data$days_to_last_followup)

# 3) ุญุณุงุจ ุฒูู ุงูุจูุงุก (OS.time): ููุช ุงูููุงุฉ ุฃู ุขุฎุฑ ูุชุงุจุนุฉ

maf_file@clinical.data$OS.time <- ifelse(!is.na(dtd), dtd, dtlf)

# ุชุฃููุฏ ุฃู ุงูููู ุฑูููุฉ

maf_file@clinical.data[,vital_status :=  as.numeric(vital_status)]
maf_file@clinical.data[,OS.time :=  as.numeric(OS.time)]


```

### 6.2 ๐งฌ ุชุญููู ุชุฃุซูุฑ ุงูุทูุฑุงุช ุนูู ุงูุญูุงุฉ ูู ุฌูู ูุงุญุฏ ููุท

```{r Survival analysis}

# 4) ุชุญููู ุงูุจูุงุก ูุฌูู ูุญุฏุฏ (ูุซุงู: NEB)

mafSurvival(maf = maf_file, genes = 'NEB', time = 'OS.time', Status = 'vital_status', isTCGA = FALSE)


```


### 6.3 ๐งฌ ุชุญููู ุชุฃุซูุฑ ุงูุทูุฑุงุช ุนูู ุงูุญูุงุฉ ุจุงุณุชุฎุฏุงู ูุฌููุนุงุช ูู ุงูุฌููุงุช


```{r survival analysis - gene sets}

# 5) ุชุญููู ุงูุจูุงุก ูุฃูุซุฑ ูู ุฌูู

# ุงูุจุญุซ ุนู ูุฌููุนุงุช ุฌููุงุช (ูุซูุงู 2 ุฌูู) ูู ุจูู ุฃุนูู 100 ุฌูู ูุชููุน ุงูุจูุงุก

prog_geneset = survGroup(maf = maf_file, top = 100, geneSetSize = 2, time = "OS.time", Status = "vital_status", verbose = FALSE)


#ุนุฑุถ ุฃูู 5 ุตููู ูู ุงููุชูุฌุฉ
head(prog_geneset, 5)

```

### 6.4 ๐ชข ุฑุณู ูุชุงุฆุฌ ุงูุชุญููู ููุฌููุนุฉ ูู ุงูุฌููุงุช


```{r plot survaival analysis of two genes}

# ูุซุงู: ุชุญููู ุงูุจูุงุก ูุฌููู MUC17 ู BRCA2

mafSurvGroup(maf = maf_file, geneSet = c("MUC17", "BRCA2"), time = "OS.time", Status = "vital_status")


```

## 7. ุฑุจุท ุงูุทูุฑุงุช ุงูุฌูููุฉ ุจุงูุจูุงูุงุช ุงูุณุฑูุฑูุฉ

### 7.1 ๐ฉโโ๏ธ ูู ุชูุฌุฏ ุฌููุงุช ุชุชุฑุงูู ุทูุฑุงุชูุง ูุน ุฌูุณ ุงููุฑูุถุ

#### 7.1.1 ๐ ูุชุฃูุฏ ูู ุฃู ุงูุจูุงูุงุช ููุงุณุจุฉ ูุฅุฌุฑุงุก ุงูุชุญููู ุงูุฅุญุตุงุฆู.

```{r Clinical enrichment analysis - gender}

# ุชูุฒูุน ุงูุนููุงุช ุญุณุจ ุงูุฌูุณ

table_gender <- table(maf_file@clinical.data$gender) 

barplot(table_gender,
        main = "Gender distribution of breast tumor cases",
        ylab = "Count",
        col = c("pink", "lightblue"))

#ููุงุญุธ ุฃู ุนุฏุฏ ุงูุฐููุฑ ุฃูู ุจูุซูุฑ ูู ุนุฏุฏ ุงูุฅูุงุซ ูุจุงูุชุงูู ูุง ูููููุง ุฅุฌุฑุงุก ุงูููุงุฑูุฉ

```


### 7.2 โข๏ธ ูู ุชูุฌุฏ ุฌููุงุช ุชุชุฑุงูู ุทูุฑุงุชูุง ูุน ุญุงูุฉ ุงูุนูุงุฌ ุงูุฅุดุนุงุนู ูููุฑูุถุ

#### 7.2.1 ูุชุฃูุฏ ูู ุฃู ุงูุจูุงูุงุช ููุงุณุจุฉ ูุฅุฌุฑุงุก ุงูุชุญููู ุงูุฅุญุตุงุฆู.


```{r Check radiation therapy}

# ููุฎุต ุญุงูุฉ ุงูุนูุงุฌ ุงูุฅุดุนุงุนู ูู ุงูุจูุงูุงุช ุงูุณุฑูุฑูุฉ

table_radiation <- table(maf_file@clinical.data$radiation_therapy)

#ุฑุณู ุชูุฒูุน ุงูุญุงูุงุช

barplot(table_radiation,
        main = "Radiation therapy status",
        ylab = "Count",
        col = c("orange", "gray70", "gray90", "lightblue", "tomato"),
        las = 2)  # rotate labels for readability

```

#### 7.2.2 ูุญุชุงุฌ ูุฅุฒุงูุฉ ุงูุจูุงูุงุช ุงูุบูุฑ ููุณุฌูุฉ ุฃู ุงูููููุฏุฉ.

``` {r engineer radiation therapy data}

# ุชูุญูุฏ ุงูููู ุฅูู YES/NO ููุทุ ููุง ุนุฏุง ุฐูู ูุญููู ุฅูู NA
maf_file@clinical.data$radiation_therapy <- ifelse(
  maf_file@clinical.data$radiation_therapy %in% c("NO", "YES"),
  maf_file@clinical.data$radiation_therapy,
  NA
)

# ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฌุฏูู ุจุนุฏ ุงูุชูุธูู
table_radiation <- table(maf_file@clinical.data$radiation_therapy)

# ุฑุณู ุงูุชูุฒูุน ุจุนุฏ ุงูุชูุธูู (YES/NO ููุท)
barplot(table_radiation,
        main = "Radiation therapy status",
        ylab = "Count",
        col = c( "lightblue", "tomato"),
        las = 2)  # rotate labels for readability

```

#### 7.2.3 ๐ ูููู ุงูุขู ุจุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑ ุงูุฅุญุตุงุฆู.

```{r Clinical enrichment analysis - radiation_therapy}

# Clinical feature enrichment using maftools
radiation_therapy.ce = clinicalEnrichment(maf = maf_file, clinicalFeature = 'radiation_therapy')

head(radiation_therapy.ce)

# ุฅุจุฑุงุฒ ุงูููุงุฑูุงุช ุฐุงุช ุงูุฏูุงูุฉ ุงูุฅุญุตุงุฆูุฉ (p < 0.05)
radiation_therapy.ce$groupwise_comparision[p_value < 0.05]


# ุฑุณู ุงููุชุงุฆุฌ ูุน ุญุฏ ุฏูุงูุฉ ุตุงุฑู p <= 0.001
plotEnrichmentResults(enrich_res = radiation_therapy.ce, pVal = 0.001, geneFontSize = 0.5, annoFontSize = 0.6)


```

#### 7.2.4 ๐ ุงุณุชุฎุฑุงุฌ ุงูุฌููุงุช ุงููุฑุชุจุท ุจุงูุนูุงุฌ ุงูุงุดุนุงุนู ุจุทุฑููุฉ ุฃูุซุฑ ุตุญุฉ ุฅุญุตุงุฆูุง

```{r plot sig genes}

# Extract pairwise comparisons table
df <- radiation_therapy.ce$pairwise_comparision

# extract numerator/denominator and compute relative frequencies
df[, c("mut1", "total1") := tstrsplit(n_mutated_Feature1, " of ", fixed=TRUE)]
df[, c("mut2", "total2") := tstrsplit(n_mutated_Feature2, " of ", fixed=TRUE)]

# Convert to numeric
df[, `:=`(mut1 = as.numeric(mut1),
          total1 = as.numeric(total1),
          mut2 = as.numeric(mut2),
          total2 = as.numeric(total2))]

# Compute relative values
df[, rel1 := mut1 / total1]
df[, rel2 := mut2 / total2]

df <- df[order(-rel1, -rel2)]
df <- df[fdr < 0.01]

# Take top 10 significant genes
top10 <- df[order(fdr)][1:10]


# Reshape to long format for ggplot
plotdf <- melt(top10,
               id.vars = "Hugo_Symbol",
               measure.vars = c("rel1", "rel2"),
               variable.name = "Feature",
               value.name = "Relative")

# Make Feature labels clearer
plotdf[, Feature := fifelse(Feature == "rel1", "Feature_1 (YES)", "Feature_2 (NO)")]

# Plot
ggplot(plotdf, aes(x = reorder(Hugo_Symbol, Relative), y = Relative, fill = Feature)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  coord_flip() +
  labs(x = "Gene", y = "Relative mutated fraction",
       title = "Top 10 significant genes by relative mutation frequency") +
  theme_minimal()


```

#### 7.2.5 ๐ฏ Effect Size vs Significance


```{r plot }
# ูุฑู ุงููุณุจุฉ ุจูู ุงููุฌููุนุชูู ูุญุฌู ุชุฃุซูุฑ ูุจุณูุท
top10[, diff_rel := rel1 - rel2]

ggplot(top10, aes(x = diff_rel, y = -log10(fdr), label = Hugo_Symbol)) +
  geom_point() +
  geom_text_repel() +
  theme_minimal() +
  labs(x = "Difference in relative mutation (Feature1 - Feature2)",
       y = "-log10(FDR)",
       title = "Effect size vs significance")
```

## 8. ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุฌูููุฉ ูุงูุฏูุงุฆูุฉ

### 8.1 ๐ ุงูุจุญุซ ุนู ุงูุฃุฏููุฉ ุงูููุงุณุจุฉ ููู ุฌูู ูู ููู MAF

```{r drug-gene interactions}
# ุงูุจุญุซ ุนู ุชูุงุนูุงุช ุฏูุงุก-ุฌูู ูููุญุฉ ุงูุฌููุงุช ุงููุณุชุฎูุตุฉ ูู ุงูู MAF
dgi = drugInteractions(maf = maf_file, fontSize = 0.75)

```


### 8.2 ูุงุฐุง ุนู ุฌูู ูุงุญุฏ ููุทุ


```{r DGI - specific gene}

# ุงุณุชุฑุฌุงุน ุงูุชูุงุนูุงุช ุงูุฏูุงุฆูุฉ ูุฌูู ูุญุฏุฏ
dnmt3a.dgi = drugInteractions(genes = "TP53", drugs = TRUE)

# ุนุฑุถ ุฃุนูุฏุฉ ูุฎุชุงุฑุฉ ูููุฏุฉ ููุชูุงุฑูุฑ
dnmt3a.dgi[,.(Gene, interaction_types, drug_name, drug_claim_name)]

```

## 9. ุงุณุชุฎุฑุงุฌ ูุณุงุฑุงุช ุฃูุถูุฉ ููุชุฃุซุฑุฉ ุจุงูุทูุฑุงุช


```{r Oncogenic Signaling Pathways}

pws = pathways(maf = maf_file, plotType = 'bar')

pws

```

## 10. ๐งฉ  ุฏุฑุงุณุฉ ุชููุน ุงูุทูุฑุงุช ุฏุงุฎู ุงูุฃูุฑุงู

```{r Tumor heterogeneity and MATH scores}

# mclust ูุทููุจุฉ ูุชุฌููุน ุงูุชูุฒูุนุงุช (Gaussian mixture models)
library("mclust")

```

ูุฎุงุฑ ุนููุฉ ูุงุญุฏุฉ ููุท ููุฏุฑุณ ููู ุชุชููุน ุงูุทูุฑุงุช ูู ูุฐู ุงูุนููุฉ

```{r tumor}

hetero_breast_tumor = inferHeterogeneity(maf = maf_file, tsb = 'TCGA-3C-AAAU-01A-11D-A41F-09')

print(hetero_breast_tumor$clusterMeans)

#Visualizing results
plotClusters(clusters = hetero_breast_tumor)


```

## 11. Mutation Signature 

```{r signature}

library('NMF')
library("BSgenome.Hsapiens.UCSC.hg19", quietly = TRUE)
```

### 11.1 Trinucleotides 

```{r }



laml.tnm = trinucleotideMatrix(maf = maf_file, prefix = 'chr', add = TRUE, ref_genome = "BSgenome.Hsapiens.UCSC.hg19")

plotApobecDiff(tnm = laml.tnm, maf = maf_file, pVal = 0.2)


```

### 11.2 ๐ข Estimate Optimal Number of Signatures

```{r estimateSignatures}

laml.sign = estimateSignatures(mat = laml.tnm, nTry = 6)

plotCophenetic(res = laml.sign)
```

### 11.3 โ๏ธ Extract NMF signatures for chosen K

```{r extract signature }


laml.sig = extractSignatures(mat = laml.tnm, n = 3)

```


### 11.4 ๐ Compare against COSMIC reference signatures

```{r compare signature}

#Compate against original 30 signatures 
laml.og30.cosm = compareSignatures(nmfRes = laml.sig, sig_db = "legacy")

#Compate against updated version3 60 signatures 
laml.v3.cosm = compareSignatures(nmfRes = laml.sig, sig_db = "SBS")


```

### 11.5 โจ๏ธ Heatmap: cosine similarity to validated signatures

```{r heatmap signature}

library('pheatmap')

pheatmap::pheatmap(mat = laml.og30.cosm$cosine_similarities, cluster_rows = FALSE, main = "cosine similarity against validated signatures")

```

### 11.6  Plot extracted signatures (SBS labels)

```{r plot signature}

maftools::plotSignatures(nmfRes = laml.sig, title_size = 1.2, sig_db = "SBS")


```
