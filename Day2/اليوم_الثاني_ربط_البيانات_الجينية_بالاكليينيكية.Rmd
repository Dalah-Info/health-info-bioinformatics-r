---
title: 'اليوم الثاني: تحليل البيانات الجينية وربطها بالبيانات الإكلينيكية '
output:
  html_document:
    lang: ar
    css: ../sc/style.css
    df_print: paged
  pdf_document: default
editor_options:
  markdown:
    wrap: sentence
---

--

# ماهي ملفات MAF؟

<br><br>

ملف **MAF** هو اختصار لـ **Mutation Annotation Format**، وهو صيغة ملفات قياسية تُستخدم بشكل واسع في المعلوماتية الحيوية (Bioinformatics) لتخزين وتمثيل بيانات الطفرات الجينية المكتشفة في الدراسات الجينومية، خصوصًا في مجال أبحاث السرطان.

يُعتبر ملف الـ MAF تنسيقًا جدوليًا (جدول نصي مفصول بفواصل أو تبويبات) يضم معلومات وصفية عن كل طفرة جينية، بحيث يتيح للباحثين تبادل البيانات وتحليلها بطريقة موحّدة ومنظمة.

**🟠 المحتويات الأساسية لملف MAF:**

▪️ **Gene Symbol (رمز الجين)**: اسم الجين الذي حدثت فيه الطفرة.

▪️ **Chromosome (الكروموسوم)**: موقع الطفرة على الكروموسوم.

▪️ **Start/End Position (موضع البداية والنهاية):** الموقع الجينومي للطفرات.

▪️ **Variant Classification (تصنيف الطفرة):** يحدد نوع الطفرة (مثل: Silent، Missense، Nonsense، Frame-shift...).

▪️ **Variant Type (نوع التغير):** مثل SNP (تعدد أشكال النوكليوتيدات المفردة) أو Insertion أو Deletion.

▪️ **Reference & Tumor Allele (الأليل المرجعي وأليل الورم):** مقارنة بين التسلسل المرجعي والتغير المرصود.

▪️ **Sample Information (معلومات العينة):** مثل المريض، نوع النسيج (ورمي أو طبيعي).

ننطلق الآن للعمل على هذا الملف!

<br><br>

------------------------------------------------------------------------

## 1. سنقوم بتهيئة بيئة العمل، ثم نحمّل الحزم البرمجية التي سنحتاج إليها أثناء هذه الورشة.

<br><br>

```{r Setting up the environment}

library(maftools)
library(dplyr)
library(skimr)
library(tidyverse)
library(ggplot2)
library(data.table)
library(ggrepel)


```

<br><br>

## 2. نقوم بقراءة ملف البيانات الوصفية الذي تم حفظه في اليوم الأول

<br><br>

```{r load metadata}

url <- "https://raw.githubusercontent.com/Dalah-Info/health-info-bioinformatics-r/refs/heads/main/Day1/Breast_tumor_metadata_cleaned.csv"
Breast_tumor_metadata = read.csv(url,  row.names = NULL)

```

<br><br>

## 3. نقوم بقراءة ملف الطفرات الجينية: MFA

<br><br>

```{r load maf file}

url2 <- "https://github.com/Dalah-Info/health-info-bioinformatics-r/raw/refs/heads/main/maf_file/filtered_maf_breast_only_maftools.maf.gz"
maf_file = read.maf(maf = url2)

```

<br><br>

## 4. نستكشف شكل ملف MAF والبيانات المسجلة فيه

<br><br>

```{r explore maf file}

head(maf_file@data) #البيانات الوصفية للحينات نجدها في هذه الخانة


```

نقوم باستخدام أداة **skimr** لتقرأ لنا الملف كاملا

```{r skim maf file}

skim(maf_file@data) 

```

<br><br>

## 5. دمج ملف البيانات الوصفية والاكلينيكية مع ملف MAF

<br><br>

**لماذا؟ 🔴**

عادة ما يأتي ملف MAF منفصلا عن الملف الوصفي، ونحتاج لدمجهما معًا حتى نتمكن من تحليل الطفرات وربطها بهذه البيانات.

**كيف؟ 🔴**

نحتاج إلى عمود واحد مشترك بين الملفين، عادة يكون رمز العينة

**أين نجد رمز العينة؟ 🔴**

في ملف MAF، هناك نمطان من ترميز العينات (Sample Barcoding) يجب الانتباه لهما:

1)  نمط TCGA

2)  نمط UUID

اختر النمط الموجود في ملف الـ MAF وأيضًا في البيانات الوصفية (Metadata)، حتى تتمكن من ربط الجدولين باستخدام هذا العمود.

```{r patient ID in MAF file}

head(unique(maf_file@data$Tumor_Sample_UUID), 5) #لايوجد مدخلات

head(unique(maf_file@data$Tumor_Sample_Barcode),5)

```

<br><br>

سوف نختار رمز TCGA لأن UUID غير موجود في ملف الـ MAF.

**🔴 رمز العينة في ملف MAF:**

*TCGA-OL-A66K-01A-11D-A29N-09* هو رمز كامل للعينة (sample/aliquot barcode).
ويتكوّن من:

▪️ TCGA → المشروع (Project)

▪️ OL → موقع مصدر النسيج (Tissue Source Site - TSS)

▪️ A66K → معرّف المشارك (المريض) (Participant/Patient ID)

▪️ 01A → نوع العينة + القارورة (01 = ورم أولي "Primary tumor" ؛ A = قارورة)

▪️ 11D → الجزء + المحلل الحيوي (11 = جزء، D = DNA)

▪️ A29N → الصفيحة (Plate)

▪️ 09 → المركز (Center)

هل توجد هذه البيانات في ملف البيانات الوصفية؟ لنتحقق من ذلك

<br><br>

```{r explore patient ID in metadata}

head(unique(Breast_tumor_metadata$bcr_patient_barcode),5)

```

<br><br>

**🔴رمز العينة في البيانات الوصفية (Metadata):**

لدينا فقط رمز المريض (Patient Barcode) مثل: *TCGA-EW-A6S9*، وهو يتكون فقط من أول 12 حرفًا من رمز الـ TCGA الكامل الموجود في ملف MAF.

✅ إذن القاعدة هي: **رمز المريض في الملف الوصفي = أول 12 حرف من رمز العينة في ملف MAF**.

<br><br>

```{r get unique patient ID}

#ننشئ ملف بيانات يحتوي على الرمز الطويل والقصير للمريض، لنستخدمه لاحقا للدمج.

id_map <- data.frame(
  short_id = substr(maf_file@data$Tumor_Sample_Barcode, 1, 12),             # معرّف المريض (12 حرف)
  Tumor_Sample_Barcode = as.character(maf_file@data$Tumor_Sample_Barcode),  # المعرّف الكامل للعينة
  stringsAsFactors = FALSE
)

#إزالة التكرار على مستوى المريض 
id_map <- id_map[!duplicated(id_map$short_id), ]


matched_clinical_data <- merge(
  x = Breast_tumor_metadata,     # البيانات السريرية
  y = id_map,                    # خريطة المعرّفات من ملف الـ MAF
  by.x = "bcr_patient_barcode",  # اسم عمود المريض في البيانات السريرية
  by.y = "short_id",             # اسم عمود المريض (12 حرف) في الخريطة
  all.x = FALSE                  # احتفظ فقط بالمرضى الموجودين في الـ MAF
)


## الآن: matched_clinical_data يحوي فقط المرضى المطابقين، وبداخله عمود Tumor_Sample_Barcode المشترك.


```

<br><br>

**✅ نستطيع الآن إنشاء ملف MAF مكتمل، يحتوي على البيانات الوصفية الإكلينيكية:**

<br><br>

```{r integrate maf and metadata file}

maf_file <- read.maf(maf = url2, clinicalData = matched_clinical_data, verbose = F)

```


---

## 5. ننطلق الآن لاستكشاف الطفرات الجينية المُسجلة في ملف MAF!

<br><br>

### 5.1 ملخص الطفرات المٌسجلة في ملف MAF لكل مريض.

```{r get sample summary}

getSampleSummary(maf_file)

```

<br><br>

### 5.2 ملخص الطفرات المٌسجلة في ملف MAF لكل جين.


```{r get gene summary}

getGeneSummary(maf_file)

```

<br><br>

### 5.3 رسم ملخص شامل لمعظم البيانات 

```{r plot maf summary}
# رسم ملخص شامل: عدد الطفرات، نسب الأنواع المختلفة، إحصائيات عامة

plotmafSummary(maf = maf_file, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)

```

<br><br>

### 5.4 رسم Oncoplot لأكثر 10 جينات تعرضاً للطفرات

تعبر رسمة الـ oncoplot واحدة من أشهر الرسومات المرتبطة بدراسة الطفرات


```{r plot oncoplot of top 10 genes}

# oncoplot يعرض الجينات الأعلى تكراراً في عينات المرضى

oncoplot(maf = maf_file, top = 10)

```

### 5.5 🔄 تحليل Transition / Transversion (Ti/Tv)

```{r plot titv summary }

# حساب أنواع الاستبدال (Ti/Tv) في الطفرات

laml.titv = titv(maf = maf_file, plot = FALSE, useSyn = TRUE)

# رسم ملخص Ti/Tv
plotTiTv(res = laml.titv)

```

### 5.6 رسم توزيع الأليلات: Variant Allele Frequency

```{r Variant Allele Frequencies}

plotVaf(maf = maf_file, vafCol = NULL, top = 20)


```


### 5.7 ⚔️ تحليل العلاقة بين الجينات، متناقضة أم متحدة؟

```{r somatic Interactions}
# يكشف عن علاقة التعايش أو التنافي بين الطفرات في الجينات

somaticInteractions(maf = maf_file, top = 25, pvalue = c(0.05, 0.1))

```

## 6. تحليل تأثير الطفرات على الحياة (هل تؤثر الطفرات في هذا الجين على مدة العيش؟)

### 6.1 نتأكد بأن البيانات تستوفي الشكل المطلوب لتطبيق التحليل

```{r data engineering - survival analysis}

# 1) تحويل حالة الوفاة إلى 0/1
maf_file@clinical.data$vital_status <- ifelse(maf_file@clinical.data$vital_status %in% c("Dead", "1"), 1, 0)

# 2) تحويل الأيام إلى قيم رقمية
num <- function(x) suppressWarnings(as.numeric(as.character(x)))
dtd  <- num(maf_file@clinical.data$days_to_death)
dtlf <- num(maf_file@clinical.data$days_to_last_followup)

# 3) حساب زمن البقاء (OS.time): وقت الوفاة أو آخر متابعة

maf_file@clinical.data$OS.time <- ifelse(!is.na(dtd), dtd, dtlf)

# تأكيد أن القيم رقمية

maf_file@clinical.data[,vital_status :=  as.numeric(vital_status)]
maf_file@clinical.data[,OS.time :=  as.numeric(OS.time)]


```

### 6.2 🧬 تحليل تأثير الطفرات على الحياة في جين واحد فقط

```{r Survival analysis}

# 4) تحليل البقاء لجين محدد (مثال: NEB)

mafSurvival(maf = maf_file, genes = 'NEB', time = 'OS.time', Status = 'vital_status', isTCGA = FALSE)


```


### 6.3 🧬 تحليل تأثير الطفرات على الحياة باستخدام مجموعات من الجينات


```{r survival analysis - gene sets}

# 5) تحليل البقاء لأكثر من جين

# البحث عن مجموعات جينات (مثلاً 2 جين) من بين أعلى 100 جين لتوقع البقاء

prog_geneset = survGroup(maf = maf_file, top = 100, geneSetSize = 2, time = "OS.time", Status = "vital_status", verbose = FALSE)


#عرض أول 5 صفوف من النتيجة
head(prog_geneset, 5)

```

### 6.4 🪢 رسم نتائج التحليل لمجموعة من الجينات


```{r plot survaival analysis of two genes}

# مثال: تحليل البقاء لجيني MUC17 و BRCA2

mafSurvGroup(maf = maf_file, geneSet = c("MUC17", "BRCA2"), time = "OS.time", Status = "vital_status")


```

## 7. ربط الطفرات الجينية بالبيانات السريرية

### 7.1 👩‍⚕️ هل توجد جينات تترافق طفراتها مع جنس المريض؟

#### 7.1.1 📈 نتأكد من أن البيانات مناسبة لإجراء التحليل الإحصائي.

```{r Clinical enrichment analysis - gender}

# توزيع العينات حسب الجنس

table_gender <- table(maf_file@clinical.data$gender) 

barplot(table_gender,
        main = "Gender distribution of breast tumor cases",
        ylab = "Count",
        col = c("pink", "lightblue"))

#نلاحظ أن عدد الذكور أقل بكثير من عدد الإناث وبالتالي لا يمكننا إجراء المقارنة

```


### 7.2 ☢️ هل توجد جينات تترافق طفراتها مع حالة العلاج الإشعاعي للمريض؟

#### 7.2.1 نتأكد من أن البيانات مناسبة لإجراء التحليل الإحصائي.


```{r Check radiation therapy}

# ملخص حالة العلاج الإشعاعي من البيانات السريرية

table_radiation <- table(maf_file@clinical.data$radiation_therapy)

#رسم توزيع الحالات

barplot(table_radiation,
        main = "Radiation therapy status",
        ylab = "Count",
        col = c("orange", "gray70", "gray90", "lightblue", "tomato"),
        las = 2)  # rotate labels for readability

```

#### 7.2.2 نحتاج لإزالة البيانات الغير مُسجلة أو المفقودة.

``` {r engineer radiation therapy data}

# توحيد القيم إلى YES/NO فقط، وما عدا ذلك يحوّل إلى NA
maf_file@clinical.data$radiation_therapy <- ifelse(
  maf_file@clinical.data$radiation_therapy %in% c("NO", "YES"),
  maf_file@clinical.data$radiation_therapy,
  NA
)

# إعادة حساب الجدول بعد التنظيف
table_radiation <- table(maf_file@clinical.data$radiation_therapy)

# رسم التوزيع بعد التنظيف (YES/NO فقط)
barplot(table_radiation,
        main = "Radiation therapy status",
        ylab = "Count",
        col = c( "lightblue", "tomato"),
        las = 2)  # rotate labels for readability

```

#### 7.2.3 📈 نقوم الآن بإجراء الاختبار الإحصائي.

```{r Clinical enrichment analysis - radiation_therapy}

# Clinical feature enrichment using maftools
radiation_therapy.ce = clinicalEnrichment(maf = maf_file, clinicalFeature = 'radiation_therapy')

head(radiation_therapy.ce)

# إبراز المقارنات ذات الدلالة الإحصائية (p < 0.05)
radiation_therapy.ce$groupwise_comparision[p_value < 0.05]


# رسم النتائج مع حد دلالة صارم p <= 0.001
plotEnrichmentResults(enrich_res = radiation_therapy.ce, pVal = 0.001, geneFontSize = 0.5, annoFontSize = 0.6)


```

#### 7.2.4 📈 استخراج الجينات المرتبط بالعلاج الاشعاعي بطريقة أكثر صحة إحصائيا

```{r plot sig genes}

# Extract pairwise comparisons table
df <- radiation_therapy.ce$pairwise_comparision

# extract numerator/denominator and compute relative frequencies
df[, c("mut1", "total1") := tstrsplit(n_mutated_Feature1, " of ", fixed=TRUE)]
df[, c("mut2", "total2") := tstrsplit(n_mutated_Feature2, " of ", fixed=TRUE)]

# Convert to numeric
df[, `:=`(mut1 = as.numeric(mut1),
          total1 = as.numeric(total1),
          mut2 = as.numeric(mut2),
          total2 = as.numeric(total2))]

# Compute relative values
df[, rel1 := mut1 / total1]
df[, rel2 := mut2 / total2]

df <- df[order(-rel1, -rel2)]
df <- df[fdr < 0.01]

# Take top 10 significant genes
top10 <- df[order(fdr)][1:10]


# Reshape to long format for ggplot
plotdf <- melt(top10,
               id.vars = "Hugo_Symbol",
               measure.vars = c("rel1", "rel2"),
               variable.name = "Feature",
               value.name = "Relative")

# Make Feature labels clearer
plotdf[, Feature := fifelse(Feature == "rel1", "Feature_1 (YES)", "Feature_2 (NO)")]

# Plot
ggplot(plotdf, aes(x = reorder(Hugo_Symbol, Relative), y = Relative, fill = Feature)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  coord_flip() +
  labs(x = "Gene", y = "Relative mutated fraction",
       title = "Top 10 significant genes by relative mutation frequency") +
  theme_minimal()


```

#### 7.2.5 🎯 Effect Size vs Significance


```{r plot }
# فرق النسبة بين المجموعتين كحجم تأثير مبسّط
top10[, diff_rel := rel1 - rel2]

ggplot(top10, aes(x = diff_rel, y = -log10(fdr), label = Hugo_Symbol)) +
  geom_point() +
  geom_text_repel() +
  theme_minimal() +
  labs(x = "Difference in relative mutation (Feature1 - Feature2)",
       y = "-log10(FDR)",
       title = "Effect size vs significance")
```

## 8. استخراج البيانات الجينية والدوائية

### 8.1 💊 البحث عن الأدوية المناسبة لكل جين في ملف MAF

```{r drug-gene interactions}
# البحث عن تفاعلات دواء-جين للوحة الجينات المستخلصة من الـ MAF
dgi = drugInteractions(maf = maf_file, fontSize = 0.75)

```


### 8.2 ماذا عن جين واحد فقط؟


```{r DGI - specific gene}

# استرجاع التفاعلات الدوائية لجين محدد
dnmt3a.dgi = drugInteractions(genes = "TP53", drugs = TRUE)

# عرض أعمدة مختارة مفيدة للتقارير
dnmt3a.dgi[,.(Gene, interaction_types, drug_name, drug_claim_name)]

```

## 9. استخراج مسارات أيضية مُتأثرة بالطفرات


```{r Oncogenic Signaling Pathways}

pws = pathways(maf = maf_file, plotType = 'bar')

pws

```

## 10. 🧩  دراسة تنوع الطفرات داخل الأورام

```{r Tumor heterogeneity and MATH scores}

# mclust مطلوبة لتجميع التوزيعات (Gaussian mixture models)
library("mclust")

```

نخار عينة واحدة فقط لندرس كيف تتنوع الطفرات في هذه العينة

```{r tumor}

hetero_breast_tumor = inferHeterogeneity(maf = maf_file, tsb = 'TCGA-3C-AAAU-01A-11D-A41F-09')

print(hetero_breast_tumor$clusterMeans)

#Visualizing results
plotClusters(clusters = hetero_breast_tumor)


```

## 11. Mutation Signature 

```{r signature}

library('NMF')
library("BSgenome.Hsapiens.UCSC.hg19", quietly = TRUE)
```

### 11.1 Trinucleotides 

```{r }



laml.tnm = trinucleotideMatrix(maf = maf_file, prefix = 'chr', add = TRUE, ref_genome = "BSgenome.Hsapiens.UCSC.hg19")

plotApobecDiff(tnm = laml.tnm, maf = maf_file, pVal = 0.2)


```

### 11.2 🔢 Estimate Optimal Number of Signatures

```{r estimateSignatures}

laml.sign = estimateSignatures(mat = laml.tnm, nTry = 6)

plotCophenetic(res = laml.sign)
```

### 11.3 ✂️ Extract NMF signatures for chosen K

```{r extract signature }


laml.sig = extractSignatures(mat = laml.tnm, n = 3)

```


### 11.4 🔍 Compare against COSMIC reference signatures

```{r compare signature}

#Compate against original 30 signatures 
laml.og30.cosm = compareSignatures(nmfRes = laml.sig, sig_db = "legacy")

#Compate against updated version3 60 signatures 
laml.v3.cosm = compareSignatures(nmfRes = laml.sig, sig_db = "SBS")


```

### 11.5 ♨️ Heatmap: cosine similarity to validated signatures

```{r heatmap signature}

library('pheatmap')

pheatmap::pheatmap(mat = laml.og30.cosm$cosine_similarities, cluster_rows = FALSE, main = "cosine similarity against validated signatures")

```

### 11.6  Plot extracted signatures (SBS labels)

```{r plot signature}

maftools::plotSignatures(nmfRes = laml.sig, title_size = 1.2, sig_db = "SBS")


```
